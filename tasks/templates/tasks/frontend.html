<!doctype html>
<html>
{% load static %}
<head>
  <meta charset="utf-8">
  <title>Task Manager</title>
  <link rel="stylesheet" href="{% static 'tasks/style.css' %}">
</head>
<body>
  <div class="container">
    <h1>Task Manager</h1>

    <section class="form-section">
      <h2>Add Task</h2>
      <form id="task-form">
        <input type="text" id="title" placeholder="Title" required>
        <input type="date" id="due_date" placeholder="Due date (optional)">
        <textarea id="description" placeholder="Description (optional)"></textarea>
        <button type="submit">Add Task</button>
      </form>
      <div id="form-error" class="error"></div>
    </section>

    <section>
      <h2>Tasks</h2>
      <div class="filters">
        <button onclick="loadTasks()">All</button>
        <button onclick="loadTasks('PENDING')">Pending</button>
        <button onclick="loadTasks('COMPLETED')">Completed</button>
      </div>
      <table id="tasks-table">
        <thead>
          <tr><th>ID</th><th>Title</th><th>Due</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

<script>
const API_ROOT = '/api/tasks/';

function formatDate(d) {
  if (!d) return '';
  const dt = new Date(d);
  return dt.toLocaleDateString();
}

async function loadTasks(status) {
  let url = API_ROOT;
  if (status) url += '?status=' + status;
  const res = await fetch(url);
  const data = await res.json();
  const tbody = document.querySelector('#tasks-table tbody');
  tbody.innerHTML = '';
  data.forEach(t => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${t.id}</td>
      <td>${escapeHtml(t.title)}</td>
      <td>${formatDate(t.due_date)}</td>
      <td>${t.status}</td>
      <td>
        ${t.status === 'PENDING' ? `<button onclick="completeTask(${t.id})">Mark Completed</button>` : ''}
        <button onclick="editTask(${t.id})">Edit</button>
        <button onclick="deleteTask(${t.id})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

document.getElementById('task-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const payload = {
    title: document.getElementById('title').value,
    description: document.getElementById('description').value,
    due_date: document.getElementById('due_date').value || null
  };
  const res = await fetch(API_ROOT, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  if (res.status === 201) {
    document.getElementById('task-form').reset();
    document.getElementById('form-error').innerText = '';
    loadTasks();
  } else {
    const err = await res.json();
    document.getElementById('form-error').innerText = JSON.stringify(err);
  }
});

async function completeTask(id) {
  await fetch(API_ROOT + id + '/complete/', { method: 'POST' });
  loadTasks();
}

async function editTask(id) {
  const title = prompt('Title:');
  if (title === null) return;
  const due = prompt('Due date (YYYY-MM-DD) or leave blank:');
  const desc = prompt('Description:');
  const payload = { title, due_date: due || null, description: desc || '' };
  await fetch(API_ROOT + id + '/', {
    method: 'PUT',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  loadTasks();
}

async function deleteTask(id) {
  if (!confirm('Delete task #' + id + '?')) return;
  await fetch(API_ROOT + id + '/', { method: 'DELETE' });
  loadTasks();
}

// initial load
loadTasks();
</script>
</body>
</html>
